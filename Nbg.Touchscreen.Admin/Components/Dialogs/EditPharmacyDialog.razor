@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using Nbg.Touchscreen.Admin.Data
@using System.Text.Json
@inject AppDbContext Db
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else if (_pharmacy is null)
        {
            <MudAlert Severity="Severity.Error">Pharmacy not found.</MudAlert>
        }
        else
        {
            <MudForm @ref="_form">
                <!-- Βασικά στοιχεία -->
                <MudTextField @bind-Value="_pharmacy.Name"
                              Label="Name"
                              Required="true"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_pharmacy.Address"
                              Label="Address"
                              Variant="Variant.Outlined"
                              Class="mt-3" />

                <MudGrid Class="mt-3" Gutter="Gutter.None">
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_pharmacy.City"
                                      Label="City"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudTextField @bind-Value="_pharmacy.State"
                                      Label="State"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudTextField @bind-Value="_pharmacy.ZipCode"
                                      Label="Zip code"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Owner &amp; contact</MudText>

                <MudGrid Gutter="Gutter.None">
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_pharmacy.OwnerName"
                                      Label="Owner name"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_pharmacy.Email"
                                      Label="Email"
                                      Variant="Variant.Outlined"
                                      Immediate="true"
                                      OnBlur="ValidateEmail" />
                    </MudItem>
                    <MudItem xs="12" sm="6" Class="mt-3">
                        <MudTextField @bind-Value="_pharmacy.Phone"
                                      Label="Phone"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Location</MudText>

                <MudGrid Gutter="Gutter.None">
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_longitude"
                                      Label="Longitude"
                                      Variant="Variant.Outlined"
                                      Immediate="true"
                                      OnBlur="TryApplyLongitude" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_latitude"
                                      Label="Latitude"
                                      Variant="Variant.Outlined"
                                      Immediate="true"
                                      OnBlur="TryApplyLatitude" />
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Service</MudText>

                <MudSelect T="int?"
                           Label="Select service"
                           @bind-Value="_pharmacy.ServiceId"
                           Variant="Variant.Outlined">
                    @foreach (var s in _services)
                    {
                        <MudSelectItem T="int?" Value="@s.Id">@s.Name</MudSelectItem>
                    }
                </MudSelect>

                <!-- Ωράρια -->
                <MudDivider Class="my-4" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Working hours</MudText>

                <!-- Monday -->
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                    <MudCheckBox T="bool" @bind-Checked="_pharmacy.MondayEnabled"
                                 Label="Monday" />

                    <MudTimePicker @bind-Time="_pharmacy.MondayFrom"
                                   Label="από"
                                   Disabled="!_pharmacy.MondayEnabled"
                                   Class="ml-4"
                                   AmPm="false" />

                    <MudTimePicker @bind-Time="_pharmacy.MondayTo"
                                   Label="έως"
                                   Disabled="!_pharmacy.MondayEnabled"
                                   Class="ml-2"
                                   AmPm="false" />
                </MudStack>

                <!-- Tuesday -->
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                    <MudCheckBox T="bool" @bind-Checked="_pharmacy.TuesdayEnabled"
                                 Label="Tuesday" />

                    <MudTimePicker @bind-Time="_pharmacy.TuesdayFrom"
                                   Label="από"
                                   Disabled="!_pharmacy.TuesdayEnabled"
                                   Class="ml-4"
                                   AmPm="false" />

                    <MudTimePicker @bind-Time="_pharmacy.TuesdayTo"
                                   Label="έως"
                                   Disabled="!_pharmacy.TuesdayEnabled"
                                   Class="ml-2"
                                   AmPm="false" />
                </MudStack>

                <!-- Wednesday -->
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                    <MudCheckBox T="bool" @bind-Checked="_pharmacy.WednesdayEnabled"
                                 Label="Wednesday" />

                    <MudTimePicker @bind-Time="_pharmacy.WednesdayFrom"
                                   Label="από"
                                   Disabled="!_pharmacy.WednesdayEnabled"
                                   Class="ml-4"
                                   AmPm="false" />

                    <MudTimePicker @bind-Time="_pharmacy.WednesdayTo"
                                   Label="έως"
                                   Disabled="!_pharmacy.WednesdayEnabled"
                                   Class="ml-2"
                                   AmPm="false" />
                </MudStack>

                <!-- Thursday -->
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                    <MudCheckBox T="bool" @bind-Checked="_pharmacy.ThursdayEnabled"
                                 Label="Thursday" />

                    <MudTimePicker @bind-Time="_pharmacy.ThursdayFrom"
                                   Label="από"
                                   Disabled="!_pharmacy.ThursdayEnabled"
                                   Class="ml-4"
                                   AmPm="false" />

                    <MudTimePicker @bind-Time="_pharmacy.ThursdayTo"
                                   Label="έως"
                                   Disabled="!_pharmacy.ThursdayEnabled"
                                   Class="ml-2"
                                   AmPm="false" />
                </MudStack>

                <!-- Friday -->
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                    <MudCheckBox T="bool" @bind-Checked="_pharmacy.FridayEnabled"
                                 Label="Friday" />

                    <MudTimePicker @bind-Time="_pharmacy.FridayFrom"
                                   Label="από"
                                   Disabled="!_pharmacy.FridayEnabled"
                                   Class="ml-4"
                                   AmPm="false" />

                    <MudTimePicker @bind-Time="_pharmacy.FridayTo"
                                   Label="έως"
                                   Disabled="!_pharmacy.FridayEnabled"
                                   Class="ml-2"
                                   AmPm="false" />
                </MudStack>

                <!-- Saturday -->
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                    <MudCheckBox T="bool" @bind-Checked="_pharmacy.SaturdayEnabled"
                                 Label="Saturday" />

                    <MudTimePicker @bind-Time="_pharmacy.SaturdayFrom"
                                   Label="από"
                                   Disabled="!_pharmacy.SaturdayEnabled"
                                   Class="ml-4"
                                   AmPm="false" />

                    <MudTimePicker @bind-Time="_pharmacy.SaturdayTo"
                                   Label="έως"
                                   Disabled="!_pharmacy.SaturdayEnabled"
                                   Class="ml-2"
                                   AmPm="false" />
                </MudStack>

                <!-- Sunday -->
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                    <MudCheckBox T="bool" @bind-Checked="_pharmacy.SundayEnabled"
                                 Label="Sunday" />

                    <MudTimePicker @bind-Time="_pharmacy.SundayFrom"
                                   Label="από"
                                   Disabled="!_pharmacy.SundayEnabled"
                                   Class="ml-4"
                                   AmPm="false" />

                    <MudTimePicker @bind-Time="_pharmacy.SundayTo"
                                   Label="έως"
                                   Disabled="!_pharmacy.SundayEnabled"
                                   Class="ml-2"
                                   AmPm="false" />
                </MudStack>

                <!-- Αργίες -->
                <MudDivider Class="my-4" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">Bank holidays</MudText>

                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                    <MudDatePicker @bind-Date="_newHolidayDate"
                                   Label="Add bank holiday"
                                   DateFormat="dd/MM/yyyy" />
                    <MudButton Class="ml-2"
                               Variant="Variant.Outlined"
                               OnClick="AddHoliday">
                        Add
                    </MudButton>
                </MudStack>

                <MudChipSet T="DateOnly">
                    @foreach (var d in _bankHolidays.OrderBy(d => d))
                    {
                        <MudChip T="DateOnly"
                                 Value="d"
                                 Closeable="true"
                                 OnClose="@(() => RemoveHoliday(d))">
                            @d.ToString("dd/MM/yyyy")
                        </MudChip>
                    }
                </MudChipSet>
            </MudForm>
        }
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="@(() => DialogInstance?.Cancel())">
            Cancel
        </MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   Disabled="_saving"
                   OnClick="Save">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small"
                                     Indeterminate="true"
                                     Class="mr-2" />
            }
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance? DialogInstance { get; set; }
    [Parameter] public int PharmacyId { get; set; }

    private MudForm? _form;
    private Pharmacy? _pharmacy;
    private bool _loading = true;
    private bool _saving;

    private List<Service> _services = new();

    private string? _longitude;
    private string? _latitude;

    private DateTime? _newHolidayDate;
    private List<DateOnly> _bankHolidays = new();

    protected override async Task OnInitializedAsync()
    {
        _pharmacy = await Db.Pharmacies.FirstOrDefaultAsync(p => p.Id == PharmacyId);
        _services = await Db.Services
            .Where(s => s.IsActive)
            .OrderBy(s => s.Name)
            .ToListAsync();

        if (_pharmacy is not null)
        {
            _longitude = _pharmacy.Longitude?.ToString(System.Globalization.CultureInfo.InvariantCulture);
            _latitude  = _pharmacy.Latitude?.ToString(System.Globalization.CultureInfo.InvariantCulture);

            // Φόρτωμα bank holidays από JSON
            if (!string.IsNullOrWhiteSpace(_pharmacy.BankHolidaysJson))
            {
                try
                {
                    _bankHolidays = JsonSerializer.Deserialize<List<DateOnly>>(_pharmacy.BankHolidaysJson!)
                                   ?? new List<DateOnly>();
                }
                catch
                {
                    _bankHolidays = new List<DateOnly>();
                }
            }
        }

        _loading = false;
    }

    private void AddHoliday()
    {
        if (_newHolidayDate is null)
            return;

        var d = DateOnly.FromDateTime(_newHolidayDate.Value.Date);
        if (!_bankHolidays.Contains(d))
            _bankHolidays.Add(d);

        _newHolidayDate = null;
    }

    private void RemoveHoliday(DateOnly d)
        => _bankHolidays.Remove(d);

    private void ValidateEmail(FocusEventArgs args)
    {
        if (string.IsNullOrWhiteSpace(_pharmacy?.Email))
            return;

        try
        {
            _ = new System.Net.Mail.MailAddress(_pharmacy!.Email);
        }
        catch
        {
            Snackbar.Add("Invalid email format.", Severity.Warning);
        }
    }

    private void TryApplyLongitude(FocusEventArgs _)
    {
        if (_pharmacy is null) return;

        if (double.TryParse(_longitude,
                            System.Globalization.NumberStyles.Float,
                            System.Globalization.CultureInfo.InvariantCulture,
                            out var val))
            _pharmacy.Longitude = val;
        else
            Snackbar.Add("Invalid longitude.", Severity.Warning);
    }

    private void TryApplyLatitude(FocusEventArgs _)
    {
        if (_pharmacy is null) return;

        if (double.TryParse(_latitude,
                            System.Globalization.NumberStyles.Float,
                            System.Globalization.CultureInfo.InvariantCulture,
                            out var val))
            _pharmacy.Latitude = val;
        else
            Snackbar.Add("Invalid latitude.", Severity.Warning);
    }

    private async Task Save()
    {
        if (_pharmacy is null)
        {
            Snackbar.Add("Pharmacy not found.", Severity.Error);
            return;
        }

        await _form!.Validate();
        if (!_form.IsValid)
            return;

        if (string.IsNullOrWhiteSpace(_pharmacy.Name))
        {
            Snackbar.Add("Name is required.", Severity.Error);
            return;
        }

        try
        {
            _saving = true;

            // σώζουμε τις αργίες σε JSON
            _pharmacy.BankHolidaysJson = JsonSerializer.Serialize(_bankHolidays);

            Db.Pharmacies.Update(_pharmacy);
            await Db.SaveChangesAsync();

            Snackbar.Add("Pharmacy updated.", Severity.Success);
            DialogInstance?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving pharmacy: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }
}
