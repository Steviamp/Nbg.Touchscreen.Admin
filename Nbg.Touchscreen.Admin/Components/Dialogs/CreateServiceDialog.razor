@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using Nbg.Touchscreen.Admin.Data
@using System.Text.Json
@inject AppDbContext Db
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form">
            <MudTextField @bind-Value="_name"
                          Label="Service Name"
                          Required="true"
                          Variant="Variant.Outlined" />

            <MudTextField @bind-Value="_ip"
                          Label="Service IP"
                          Required="true"
                          Variant="Variant.Outlined"
                          Class="mt-3" />

            <MudNumericField @bind-Value="_port"
                             Label="Service Port"
                             Required="true"
                             Variant="Variant.Outlined"
                             Class="mt-3" />

            <!-- Queue dropdown -->
            <MudSelect T="int?" Label="Select Queue"
                       @bind-Value="_queueId"
                       Variant="Variant.Outlined"
                       Class="mt-3">
                <MudSelectItem T="int?" Value="@((int?)null)">– none –</MudSelectItem>
                @foreach (var q in _queues)
                {
                    <MudSelectItem T="int?" Value="@q.Id">@q.Name</MudSelectItem>
                }
            </MudSelect>

            <!-- Working hours for ticket issuing -->
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.subtitle2" Class="mb-2">Working hours (ticket issuing)</MudText>

            <!-- Monday -->
            <div class="d-flex align-center mb-3" style="gap: 12px;">
                <label class="d-flex align-center" style="min-width: 120px; cursor: pointer;">
                    <input type="checkbox"
                           checked="@_mondayEnabled"
                           @onchange="@((ChangeEventArgs e) => _mondayEnabled = (bool)e.Value!)"
                           style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;" />
                    <span>Monday</span>
                </label>

                <MudTimePicker @bind-Time="_mondayFrom"
                               Label="από"
                               Disabled="!_mondayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />

                <MudTimePicker @bind-Time="_mondayTo"
                               Label="έως"
                               Disabled="!_mondayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />
            </div>

            <!-- Tuesday -->
            <div class="d-flex align-center mb-3" style="gap: 12px;">
                <label class="d-flex align-center" style="min-width: 120px; cursor: pointer;">
                    <input type="checkbox"
                           checked="@_tuesdayEnabled"
                           @onchange="@((ChangeEventArgs e) => _tuesdayEnabled = (bool)e.Value!)"
                           style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;" />
                    <span>Tuesday</span>
                </label>

                <MudTimePicker @bind-Time="_tuesdayFrom"
                               Label="από"
                               Disabled="!_tuesdayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />

                <MudTimePicker @bind-Time="_tuesdayTo"
                               Label="έως"
                               Disabled="!_tuesdayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />
            </div>

            <!-- Wednesday -->
            <div class="d-flex align-center mb-3" style="gap: 12px;">
                <label class="d-flex align-center" style="min-width: 120px; cursor: pointer;">
                    <input type="checkbox"
                           checked="@_wednesdayEnabled"
                           @onchange="@((ChangeEventArgs e) => _wednesdayEnabled = (bool)e.Value!)"
                           style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;" />
                    <span>Wednesday</span>
                </label>

                <MudTimePicker @bind-Time="_wednesdayFrom"
                               Label="από"
                               Disabled="!_wednesdayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />

                <MudTimePicker @bind-Time="_wednesdayTo"
                               Label="έως"
                               Disabled="!_wednesdayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />
            </div>

            <!-- Thursday -->
            <div class="d-flex align-center mb-3" style="gap: 12px;">
                <label class="d-flex align-center" style="min-width: 120px; cursor: pointer;">
                    <input type="checkbox"
                           checked="@_thursdayEnabled"
                           @onchange="@((ChangeEventArgs e) => _thursdayEnabled = (bool)e.Value!)"
                           style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;" />
                    <span>Thursday</span>
                </label>

                <MudTimePicker @bind-Time="_thursdayFrom"
                               Label="από"
                               Disabled="!_thursdayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />

                <MudTimePicker @bind-Time="_thursdayTo"
                               Label="έως"
                               Disabled="!_thursdayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />
            </div>

            <!-- Friday -->
            <div class="d-flex align-center mb-3" style="gap: 12px;">
                <label class="d-flex align-center" style="min-width: 120px; cursor: pointer;">
                    <input type="checkbox"
                           checked="@_fridayEnabled"
                           @onchange="@((ChangeEventArgs e) => _fridayEnabled = (bool)e.Value!)"
                           style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;" />
                    <span>Friday</span>
                </label>

                <MudTimePicker @bind-Time="_fridayFrom"
                               Label="από"
                               Disabled="!_fridayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />

                <MudTimePicker @bind-Time="_fridayTo"
                               Label="έως"
                               Disabled="!_fridayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />
            </div>

            <!-- Saturday -->
            <div class="d-flex align-center mb-3" style="gap: 12px;">
                <label class="d-flex align-center" style="min-width: 120px; cursor: pointer;">
                    <input type="checkbox"
                           checked="@_saturdayEnabled"
                           @onchange="@((ChangeEventArgs e) => _saturdayEnabled = (bool)e.Value!)"
                           style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;" />
                    <span>Saturday</span>
                </label>

                <MudTimePicker @bind-Time="_saturdayFrom"
                               Label="από"
                               Disabled="!_saturdayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />

                <MudTimePicker @bind-Time="_saturdayTo"
                               Label="έως"
                               Disabled="!_saturdayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />
            </div>

            <!-- Sunday -->
            <div class="d-flex align-center mb-3" style="gap: 12px;">
                <label class="d-flex align-center" style="min-width: 120px; cursor: pointer;">
                    <input type="checkbox"
                           checked="@_sundayEnabled"
                           @onchange="@((ChangeEventArgs e) => _sundayEnabled = (bool)e.Value!)"
                           style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;" />
                    <span>Sunday</span>
                </label>

                <MudTimePicker @bind-Time="_sundayFrom"
                               Label="από"
                               Disabled="!_sundayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />

                <MudTimePicker @bind-Time="_sundayTo"
                               Label="έως"
                               Disabled="!_sundayEnabled"
                               AmPm="false"
                               Variant="Variant.Outlined"
                               Style="flex: 1;" />
            </div>

            <!-- Bank holidays -->
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.subtitle2" Class="mb-2">Bank holidays (no ticket issuing)</MudText>

            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2" Spacing="2">
                <MudDatePicker @bind-Date="_newHolidayDate"
                               Label="Add bank holiday"
                               DateFormat="dd/MM/yyyy"
                               Variant="Variant.Outlined"
                               Class="flex-grow-1" />
                <MudButton Variant="Variant.Outlined"
                           OnClick="AddHoliday"
                           Style="min-width: 80px;">
                    Add
                </MudButton>
            </MudStack>

            @if (_bankHolidays.Any())
            {
                <MudChipSet T="DateOnly">
                    @foreach (var d in _bankHolidays.OrderBy(d => d))
                    {
                        <MudChip T="DateOnly"
                                 Value="d"
                                 Closeable="true"
                                 OnClose="@(() => RemoveHoliday(d))">
                            @d.ToString("dd/MM/yyyy")
                        </MudChip>
                    }
                </MudChipSet>
            }

            <MudDivider Class="my-4" />

            <MudCheckBox T="bool"
                         @bind-Checked="_isActive"
                         Label="Active"
                         Class="mt-1" />
        </MudForm>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="@(() => DialogInstance?.Cancel())">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   Disabled="@_saving"
                   OnClick="Save">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Create
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance? DialogInstance { get; set; }

    private MudForm? _form;
    private bool _saving;

    private string _name = string.Empty;
    private string _ip = string.Empty;
    private int? _port;

    private bool _isActive = true;

    private int? _queueId;
    private List<Queue> _queues = new();

    // working hours locals
    private bool _mondayEnabled;
    private TimeSpan? _mondayFrom;
    private TimeSpan? _mondayTo;

    private bool _tuesdayEnabled;
    private TimeSpan? _tuesdayFrom;
    private TimeSpan? _tuesdayTo;

    private bool _wednesdayEnabled;
    private TimeSpan? _wednesdayFrom;
    private TimeSpan? _wednesdayTo;

    private bool _thursdayEnabled;
    private TimeSpan? _thursdayFrom;
    private TimeSpan? _thursdayTo;

    private bool _fridayEnabled;
    private TimeSpan? _fridayFrom;
    private TimeSpan? _fridayTo;

    private bool _saturdayEnabled;
    private TimeSpan? _saturdayFrom;
    private TimeSpan? _saturdayTo;

    private bool _sundayEnabled;
    private TimeSpan? _sundayFrom;
    private TimeSpan? _sundayTo;

    private DateTime? _newHolidayDate;
    private List<DateOnly> _bankHolidays = new();

    protected override async Task OnInitializedAsync()
    {
        _queues = await Db.Queues
            .OrderBy(q => q.Name)
            .ToListAsync();

        // default ωράριο (9–17, disabled)
        var defaultFrom = new TimeSpan(9, 0, 0);
        var defaultTo = new TimeSpan(17, 0, 0);

        _mondayEnabled = false;
        _mondayFrom = defaultFrom;
        _mondayTo = defaultTo;

        _tuesdayEnabled = false;
        _tuesdayFrom = defaultFrom;
        _tuesdayTo = defaultTo;

        _wednesdayEnabled = false;
        _wednesdayFrom = defaultFrom;
        _wednesdayTo = defaultTo;

        _thursdayEnabled = false;
        _thursdayFrom = defaultFrom;
        _thursdayTo = defaultTo;

        _fridayEnabled = false;
        _fridayFrom = defaultFrom;
        _fridayTo = defaultTo;

        _saturdayEnabled = false;
        _saturdayFrom = defaultFrom;
        _saturdayTo = defaultTo;

        _sundayEnabled = false;
        _sundayFrom = defaultFrom;
        _sundayTo = defaultTo;
    }

    private void AddHoliday()
    {
        if (_newHolidayDate is null)
            return;

        var d = DateOnly.FromDateTime(_newHolidayDate.Value.Date);
        if (!_bankHolidays.Contains(d))
            _bankHolidays.Add(d);

        _newHolidayDate = null;
    }

    private void RemoveHoliday(DateOnly d)
        => _bankHolidays.Remove(d);

    private async Task Save()
    {
        if (_saving) return;
        if (_form is null) return;

        await _form.Validate();
        if (!_form.IsValid)
            return;

        if (_port is null || _port <= 0)
        {
            Snackbar.Add("Port must be a positive number.", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(_name))
        {
            Snackbar.Add("Service name is required.", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(_ip))
        {
            Snackbar.Add("Service IP is required.", Severity.Error);
            return;
        }

        try
        {
            _saving = true;

            var s = new Service
            {
                Name = _name.Trim(),
                Ip = _ip.Trim(),
                Port = _port.Value,
                IsActive = _isActive,

                MondayEnabled = _mondayEnabled,
                MondayFrom = _mondayFrom,
                MondayTo = _mondayTo,

                TuesdayEnabled = _tuesdayEnabled,
                TuesdayFrom = _tuesdayFrom,
                TuesdayTo = _tuesdayTo,

                WednesdayEnabled = _wednesdayEnabled,
                WednesdayFrom = _wednesdayFrom,
                WednesdayTo = _wednesdayTo,

                ThursdayEnabled = _thursdayEnabled,
                ThursdayFrom = _thursdayFrom,
                ThursdayTo = _thursdayTo,

                FridayEnabled = _fridayEnabled,
                FridayFrom = _fridayFrom,
                FridayTo = _fridayTo,

                SaturdayEnabled = _saturdayEnabled,
                SaturdayFrom = _saturdayFrom,
                SaturdayTo = _saturdayTo,

                SundayEnabled = _sundayEnabled,
                SundayFrom = _sundayFrom,
                SundayTo = _sundayTo,

                BankHolidaysJson = JsonSerializer.Serialize(_bankHolidays)
            };

            Db.Services.Add(s);
            await Db.SaveChangesAsync();

            if (_queueId.HasValue)
            {
                var q = await Db.Queues.FirstOrDefaultAsync(x => x.Id == _queueId.Value);
                if (q != null)
                {
                    q.ServiceType = s.Type;
                    await Db.SaveChangesAsync();
                }
            }

            Snackbar.Add("Service created.", Severity.Success);
            DialogInstance?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating service: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }
}
