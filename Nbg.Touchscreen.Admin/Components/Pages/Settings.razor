@page "/settings"
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using Nbg.Touchscreen.Admin.Data
@using System.Linq

@inject AppDbContext Db
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.False" Class="mt-6">
    <MudText Typo="Typo.h3" Class="mb-6">Settings</MudText>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Class="mb-4" />
    }
    else
    {
        <!-- ============ App settings ============ -->
        <MudPaper Class="pa-4 mb-6" Elevation="1">
            <MudText Typo="Typo.subtitle1" Class="mb-2">
                Max Number Of Tickets Allowed Per Day
            </MudText>

            <MudGrid Gutter="Gutter.None">
                <MudItem xs="12" sm="4">
                    <MudNumericField T="int"
                                     Label="Max tickets per day"
                                     @bind-Value="_maxTickets"
                                     Disabled="_saving"
                                     Min="1"
                                     Max="1000"
                                     Immediate="true" />
                </MudItem>
                <MudItem xs="12" sm="4" Class="d-flex align-center mt-3 mt-sm-0">
                    <MudButton Color="Color.Primary"
                               Variant="Variant.Filled"
                               Disabled="_saving"
                               OnClick="SaveAppSettingsAsync">
                        @if (_saving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        Save
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- ============ Global holidays ============ -->
        <MudExpansionPanels Elevation="1">
            <MudExpansionPanel Text="Global holidays"
                               Expanded="@_holidaysOpen"
                               OnExpandedChanged="(v => _holidaysOpen = v)">
                <ChildContent>
                    <MudStack Spacing="2">

                        <MudGrid Spacing="2">
                            <!-- One-off holiday -->
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">Add one-off holiday</MudText>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                    <MudDatePicker @bind-Date="_newDate" Label="Date" DateFormat="dd/MM/yyyy" Variant="Variant.Outlined" />
                                    <MudTextField @bind-Value="_newName" Label="Name" Variant="Variant.Outlined" />
                                    <MudButton Variant="Variant.Filled" OnClick="AddOneOffAsync">Add</MudButton>
                                </MudStack>
                            </MudItem>

                            <!-- Recurring holiday -->
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">Add recurring holiday (every year)</MudText>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">

                                    <MudSelect T="int" Label="Month" @bind-Value="_recMonth" Variant="Variant.Outlined" Class="w-24">
                                        @for (var m = 1; m <= 12; m++)
                                        {
                                            var month = m;
                                            <MudSelectItem T="int" Value="@month">
                                                @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(month)
                                            </MudSelectItem>
                                        }
                                    </MudSelect>

                                    <MudSelect T="int" Label="Day" @bind-Value="_recDay" Variant="Variant.Outlined" Class="w-24">
                                        @{
                                            var daysInMonth = (_recMonth >= 1 && _recMonth <= 12)
                                            ? DateTime.DaysInMonth(2000, _recMonth)
                                            : 31;
                                        }
                                        @for (var d = 1; d <= daysInMonth; d++)
                                        {
                                            var day = d;
                                            <MudSelectItem T="int" Value="@day">@day</MudSelectItem>
                                        }
                                    </MudSelect>

                                    <MudTextField @bind-Value="_recName" Label="Name" Variant="Variant.Outlined" />
                                    <MudButton Variant="Variant.Filled" OnClick="AddRecurringAsync">Add</MudButton>
                                </MudStack>
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-2" />

                        <MudTable Items="_holidays" Dense="true" Hover="true">
                            <HeaderContent>
                                <MudTh>Name</MudTh>
                                <MudTh>Type</MudTh>
                                <MudTh>Date/Month</MudTh>
                                <MudTh></MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.Name</MudTd>
                                <MudTd>@(context.IsRecurring ? "Recurring" : "One-off")</MudTd>
                                <MudTd>
                                    @if (context.IsRecurring)
                                    {
                                        @($"{context.RecurringDay:00}/{context.RecurringMonth:00}")
                                    }
                                    else
                                    {
                                        @context.Date?.ToString("dd/MM/yyyy")
                                    }
                                </MudTd>
                                <MudTd>
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Color="Color.Error"
                                                   OnClick="@(()=>DeleteHolidayAsync(context.Id))" />
                                </MudTd>
                            </RowTemplate>
                            <NoRecordsContent>
                                <MudText Class="pa-2">No holidays found.</MudText>
                            </NoRecordsContent>
                        </MudTable>

                    </MudStack>
                </ChildContent>
            </MudExpansionPanel>
        </MudExpansionPanels>

    }
</MudContainer>

@code {
    // ---------- App settings ----------
    private bool _loading = true;
    private bool _saving;
    private int _maxTickets;
    private int _settingsId = 1;

    // ---------- Global holidays ----------
    private List<GlobalHoliday> _holidays = new();
    private DateTime? _newDate;
    private string? _newName;
    private bool _holidaysOpen = false;

    private int _recMonth = 1;
    private int _recDay = 1;
    private string? _recName;

    // disposal / cancellation
    private readonly CancellationTokenSource _cts = new();
    private bool _disposed;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var ct = _cts.Token;

            // ensure AppSettings row
            var row = await Db.AppSettings.FirstOrDefaultAsync(s => s.Id == 1, ct);
            if (row == null)
            {
                row = new AppSetting { Id = 1, MaxTicketsPerDay = 5 };
                Db.AppSettings.Add(row);
                await Db.SaveChangesAsync(ct);
                if (_disposed || ct.IsCancellationRequested) return;
            }

            _settingsId = row!.Id;
            _maxTickets = row.MaxTicketsPerDay;

            // load global holidays
            _holidays = await Db.GlobalHolidays
                .OrderByDescending(h => h.IsRecurring)
                .ThenBy(h => h.RecurringMonth).ThenBy(h => h.RecurringDay)
                .ThenBy(h => h.Date)
                .ToListAsync(ct);

            if (_disposed || ct.IsCancellationRequested) return;

            _loading = false;
        }
        catch (OperationCanceledException) { /* ignore */ }
    }

    private async Task SaveAppSettingsAsync()
    {
        if (_saving) return;
        _saving = true;
        var ct = _cts.Token;

        try
        {
            var row = await Db.AppSettings.FirstAsync(s => s.Id == _settingsId, ct);
            row.MaxTicketsPerDay = _maxTickets;

            await Db.SaveChangesAsync(ct);
            if (_disposed || ct.IsCancellationRequested) return;

            await InvokeAsync(() =>
                Snackbar.Add("Settings saved successfully.", Severity.Success));
        }
        catch (OperationCanceledException) { /* ignore */ }
        catch (Exception ex)
        {
            if (!_disposed)
                await InvokeAsync(() => Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error));
        }
        finally { _saving = false; }
    }

    private async Task AddOneOffAsync()
    {
        if (_newDate is null)
        {
            if (!_disposed)
                await InvokeAsync(() => Snackbar.Add("Pick a date.", Severity.Warning));
            return;
        }

        var ct = _cts.Token;

        try
        {
            var ent = new GlobalHoliday
            {
                Name = string.IsNullOrWhiteSpace(_newName) ? "Holiday" : _newName!.Trim(),
                IsRecurring = false,
                Date = DateOnly.FromDateTime(_newDate.Value.Date),
                RecurringMonth = null,
                RecurringDay = null,
                IsActive = true
            };
            Db.GlobalHolidays.Add(ent);
            await Db.SaveChangesAsync(ct);
            if (_disposed || ct.IsCancellationRequested) return;

            _holidays.Add(ent);
            _holidays = _holidays.OrderByDescending(h => h.IsRecurring)
                                 .ThenBy(h => h.RecurringMonth).ThenBy(h => h.RecurringDay)
                                 .ThenBy(h => h.Date)
                                 .ToList();
            _newDate = null; _newName = null;

            await InvokeAsync(() => Snackbar.Add("Holiday added.", Severity.Success));
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            if (!_disposed)
                await InvokeAsync(() => Snackbar.Add($"Error adding holiday: {ex.Message}", Severity.Error));
        }
    }

    private async Task AddRecurringAsync()
    {
        if (_recMonth < 1 || _recDay < 1)
        {
            if (!_disposed)
                await InvokeAsync(() => Snackbar.Add("Select month and day.", Severity.Warning));
            return;
        }
        if (!IsValidMonthDay(_recMonth, _recDay))
        {
            if (!_disposed)
                await InvokeAsync(() => Snackbar.Add("Invalid month/day combination.", Severity.Warning));
            return;
        }

        var ct = _cts.Token;

        try
        {
            var ent = new GlobalHoliday
            {
                Name = string.IsNullOrWhiteSpace(_recName) ? "Holiday (recurring)" : _recName!.Trim(),
                IsRecurring = true,
                RecurringMonth = (byte)_recMonth,
                RecurringDay = (byte)_recDay,
                Date = null,
                IsActive = true
            };
            Db.GlobalHolidays.Add(ent);
            await Db.SaveChangesAsync(ct);
            if (_disposed || ct.IsCancellationRequested) return;

            _holidays.Add(ent);
            _holidays = _holidays.OrderByDescending(h => h.IsRecurring)
                                 .ThenBy(h => h.RecurringMonth).ThenBy(h => h.RecurringDay)
                                 .ThenBy(h => h.Date)
                                 .ToList();
            _recMonth = 1; _recDay = 1; _recName = null;

            await InvokeAsync(() => Snackbar.Add("Recurring holiday added.", Severity.Success));
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            if (!_disposed)
                await InvokeAsync(() => Snackbar.Add($"Error adding recurring holiday: {ex.Message}", Severity.Error));
        }
    }

    private async Task DeleteHolidayAsync(int id)
    {
        var ct = _cts.Token;

        try
        {
            var ent = await Db.GlobalHolidays.FirstOrDefaultAsync(h => h.Id == id, ct);
            if (ent is null) return;

            Db.GlobalHolidays.Remove(ent);
            await Db.SaveChangesAsync(ct);
            if (_disposed || ct.IsCancellationRequested) return;

            _holidays.RemoveAll(h => h.Id == id);
            await InvokeAsync(() => Snackbar.Add("Holiday deleted.", Severity.Success));
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            if (!_disposed)
                await InvokeAsync(() => Snackbar.Add($"Error deleting holiday: {ex.Message}", Severity.Error));
        }
    }

    private static bool IsValidMonthDay(int month, int day)
    {
        if (month < 1 || month > 12 || day < 1 || day > 31) return false;
        try { _ = new DateOnly(2000, month, day); return true; }
        catch { return false; }
    }

    // dispose pattern
    public void Dispose()
    {
        _disposed = true;
        _cts.Cancel();
        _cts.Dispose();
    }
}