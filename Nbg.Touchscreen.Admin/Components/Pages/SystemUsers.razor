@page "/system-users"
@rendermode InteractiveServer
@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Nbg.Touchscreen.Admin.Data
@using Nbg.Touchscreen.Admin.Components.Dialogs

@inject AppDbContext Db
@inject IDialogService Dialogs
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.False"
              Class="mt-6">

    <!-- Header / Toolbar -->
    <MudPaper Class="pa-0 mt-4">
        <MudTable T="User"
                  @ref="_users"
                  ServerData="LoadServerData"
                  RowsPerPage="10"
                  Hover="true" 
                  Dense="true" 
                  Bordered="false" 
                  Striped="true">
            <ToolBarContent>
                <MudText Typo="Typo.subtitle2">@($"{_totalItems} users")</MudText>
                <MudSpacer />
                <AuthorizeView>
                    <Authorized>
                        <MudButton 
                            Color="Color.Inherit" 
                            Variant="Variant.Outlined"
                            StartIcon="@Icons.Material.Filled.Add"
                            OnClick="OpenCreateUser" 
                            Class="ml-2">Create user
                        </MudButton>
                    </Authorized>
                </AuthorizeView>
            </ToolBarContent>

            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Role</MudTh>
                <MudTh>Created At</MudTh>
            </HeaderContent>

            <RowTemplate Context="context">
                <MudTd DataLabel="Name">
                    <div class="d-flex flex-column">
                        <span>@context.Name</span>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@context.Email</MudText>
                    </div>
                </MudTd>
                <MudTd DataLabel="Role">@context.Role</MudTd>

                <MudTd DataLabel="CreatedAt">
                    @context.CreatedAtUtc.ToLocalTime().ToString("dd-MM-yyyy HH:mm")
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   Class="mr-1"
                                   OnClick="@(() => OpenEditUser(context))" />

                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   OnClick="@(() => DeleteUser(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Class="pa-4">No users found.</MudText>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>

</MudContainer>

@code {
    private MudTable<User> _users = new();
    private string _search = "";
    private int _totalItems;

    protected override Task OnInitializedAsync() => Task.CompletedTask;

    private async Task<TableData<User>> LoadServerData(TableState state, CancellationToken token)
    {
        IQueryable<User> query = Db.Users.AsNoTracking();

        if (!string.IsNullOrWhiteSpace(_search))
        {
            var s = _search.Trim().ToLower();
            query = query.Where(u =>
                (u.Name ?? "").ToLower().Contains(s) ||
                (u.Email ?? "").ToLower().Contains(s) ||
                (u.Role ?? "").ToLower().Contains(s));
        }

        _totalItems = await query.CountAsync();

        query = query.OrderByDescending(u => u.CreatedAtUtc);

        var items = await query
            .Skip(state.Page * state.PageSize)
            .Take(state.PageSize)
            .ToListAsync();

        return new TableData<User> { TotalItems = _totalItems, Items = items };
    }

    private async Task OpenCreateUser()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        var dialogRef = await Dialogs.ShowAsync<CreateUserDialog>("Create user", options: options);
        var result = await dialogRef.Result;

        if (!result.Canceled)
        {
            await _users.ReloadServerData();
            Snackbar.Add("User created.", Severity.Success);
        }
    }

    private async Task OpenEditUser(User user)
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var parameters = new DialogParameters
        {
            ["UserId"] = user.Id
        };

        var dialogRef = await Dialogs.ShowAsync<EditUserDialog>("Edit user", parameters, options);
        var result = await dialogRef.Result;

        if (!result.Canceled)
        {
            await _users.ReloadServerData();
            Snackbar.Add("User updated.", Severity.Success);
        }
    }

    private async Task DeleteUser(User user)
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small
        };

        var parameters = new DialogParameters
    {
        { "ContentText", $"Are you sure you want to delete user '{user.Email}'? This action cannot be undone." },
        { "ButtonText", "Delete" },
        { "Color", Color.Error }
    };

        var dialog = await Dialogs.ShowAsync<ConfirmDialog>("Delete User", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                var userToDelete = await Db.Users.FindAsync(user.Id);
                if (userToDelete != null)
                {
                    Db.Users.Remove(userToDelete);
                    await Db.SaveChangesAsync();

                    Snackbar.Add($"User '{user.Email}' deleted successfully.", Severity.Success);
                    await _users.ReloadServerData();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting user: {ex.Message}", Severity.Error);
            }
        }
    }
    private async Task OnSearchKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await _users.ReloadServerData();
    }
}

